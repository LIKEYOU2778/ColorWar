<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‰²å½©å é¢†èµ› - è½»é‡UIç‰ˆ</title>
    <style>
        :root {
            --bg: #fdfdfd;
            --line: #efefef;
            --ui-text: #333;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg);
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: var(--ui-text); user-select: none;
            touch-action: none;
        }

        /* åº•å±‚ï¼šåˆ†ç•Œçº¿ä¸æ–‡å­—æŒ‡å¼• */
        #zones-layer {
            position: absolute; inset: 0; display: flex; z-index: 1; pointer-events: none;
        }
        .zone-cell {
            flex: 1; border-right: 2px solid var(--line);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .zone-cell:last-child { border-right: none; }
        /* è¿™é‡Œçš„æç¤ºå­—ä¹Ÿæ”¹å°ä¸€ç‚¹ï¼Œä¸é®æŒ¡è§†çº¿ */
        .zone-hint { text-align: center; opacity: 0.5; }
        .zone-hint h2 { font-size: 2.5vw; margin: 0; }
        .zone-hint p { font-size: 1vw; font-weight: bold; border: 1px solid currentColor; padding: 4px 8px; border-radius: 6px; margin-top: 8px; }

        /* ä¸­å±‚ï¼šç»˜å›¾å±‚ */
        canvas {
            display: block; 
            position: absolute; inset: 0; z-index: 5;
            background: transparent;
        }

        /* é¡¶å±‚ï¼šå®æ—¶ä¿¡æ¯æ  - é«˜åº¦å‡å° */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px; /* æ”¹å° */
            display: none; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 20;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--line); pointer-events: none;
            font-size: 14px;
        }
        .rank-container { display: flex; gap: 10px; }
        .rank-item {
            background: #fff; padding: 4px 10px; border-radius: 20px; /* æ”¹å° */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: bold;
            display: flex; align-items: center; gap: 6px; font-size: 12px;
        }
        #timer { font-size: 24px; font-weight: 900; color: #e74c3c; width: 40px; text-align: center; }

        /* æ¨¡æ€æ¡†ï¼šå¼€å§‹ä¸ç»“æœ */
        .modal {
            position: fixed; inset: 0; background: var(--bg);
            z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px;
        }
        .start-title { font-size: 24px; font-weight: 900; margin-bottom: 15px; } /* æ”¹å° */
        
        /* é€‰é¡¹åŒºåŸŸ */
        .settings-box {
            background: #f8f9fa; padding: 15px; border-radius: 15px; /* æ”¹å° */
            margin-bottom: 20px; width: 90%; max-width: 500px;
            text-align: center;
        }
        .settings-box h3 { margin: 0 0 10px 0; font-size: 16px; opacity: 0.7; }
        .time-options {
            display: flex; gap: 10px; justify-content: center;
        }
        .time-btn {
            background: #fff; border: 1px solid #ddd; padding: 8px 16px; /* æ”¹å° */
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;
            transition: all 0.2s;
        }
        .time-btn.active { background: #333; color: white; border-color: #333; }

        .mode-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            width: 90%; max-width: 600px;
        }
        .btn-mode {
            background: #fff; border: 2px solid var(--line); padding: 15px 0; /* æ”¹å° */
            border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-mode:hover { border-color: #333; transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); }

        .result-card {
            background: #fff; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08); text-align: center; 
            min-width: 300px; max-width: 90%;
        }
        .rank-list { margin: 20px 0; max-height: 50vh; overflow-y: auto; }
        .rank-row {
            display: flex; justify-content: space-between; padding: 10px 15px; /* æ”¹å° */
            margin-bottom: 8px; background: #f8f9fa; border-radius: 10px;
            font-size: 16px; font-weight: bold;
        }
        .btn-restart {
            background: #333; color: #fff; border: none; padding: 10px 40px;
            border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: bold;
        }

        /* Emoji åŠ¨ç”»å±‚ */
        #emoji-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 15; overflow: hidden;
        }
        .emoji-pop {
            position: absolute; font-size: 20px; /* Emoji ä¹Ÿç¨å¾®æ”¹å°ä¸€ç‚¹ */
            animation: popUp 0.8s forwards;
            user-select: none;
        }
        @keyframes popUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            50% { transform: translate(-50%, -150%) scale(1.2); opacity: 0.8; }
            100% { transform: translate(-50%, -200%) scale(0.8); opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- 1. ç‰©ç†åˆ†ç•Œçº¿å±‚ -->
    <div id="zones-layer"></div>

    <!-- 2. ç»˜å›¾å±‚ -->
    <canvas id="gameCanvas"></canvas>
    <!-- 2.5 Emojiç‰¹æ•ˆå±‚ -->
    <div id="emoji-layer"></div>

    <!-- 3. å®æ—¶çŠ¶æ€æ  -->
    <div id="top-bar">
        <div class="rank-container" id="live-rank"></div>
        <div id="timer">30</div>
        <div style="font-weight: bold; opacity: 0.3; font-size: 12px;">COLOR WAR</div>
    </div>

    <!-- 4. å¼€å§‹èœå• -->
    <div id="start-screen" class="modal">
        <div class="settings-box">
            <h3>é€‰æ‹©æ¸¸æˆæ—¶é•¿ (ç§’)</h3>
            <div class="time-options">
                <button class="time-btn" onclick="selectTime(10)">10s</button>
                <button class="time-btn active" onclick="selectTime(30)">30s</button>
                <button class="time-btn" onclick="selectTime(60)">60s</button>
                <button class="time-btn" onclick="selectTime(90)">90s</button>
            </div>
        </div>

        <div class="start-title">é€‰æ‹©ç©å®¶äººæ•°</div>
        <div class="mode-grid">
            <script>
                // å¢åŠ åˆ° 9 äºº
                for(let i=2; i<=9; i++) {
                    document.write(`<button class="btn-mode" onclick="launchGame(${i})">${i}äºº</button>`);
                }
            </script>
        </div>
        <p style="margin-top: 20px; opacity: 0.4; font-size: 12px;">å»ºè®®æ ¹æ®ç«™ä½é€‰æ‹©å¯¹åº”çš„åŒºåŸŸé¢œè‰²</p>
    </div>

    <!-- 5. ç»“æœå±å¹• -->
    <div id="result-screen" class="modal" style="display:none; background: rgba(255,255,255,0.95);">
        <div class="result-card">
            <h2 style="margin:0 0 10px 0; font-size: 22px;">æˆ˜æŠ¥æ’å</h2>
            <div class="rank-list" id="final-rank-list"></div>
            <button class="btn-restart" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { desynchronized: true });
    const zonesLayer = document.getElementById('zones-layer');
    const liveRank = document.getElementById('live-rank');
    const timerDisplay = document.getElementById('timer');
    const emojiLayer = document.getElementById('emoji-layer');

    let isRunning = false;
    let selectedTime = 30; // é»˜è®¤30ç§’
    let time = 30;
    let players = [];
    
    // ä½é¥±å’Œåº¦è‰²ç›˜
    const colorPalette = [
        { name: 'çº¢æ–¹', color: '#d66b69', emoji: 'ğŸ”¥' }, // æŸ”å’Œçº¢
        { name: 'è“æ–¹', color: '#5481e6', emoji: 'ğŸ’§' }, // é›¾éœ¾è“
        { name: 'é‡‘æ–¹', color: '#e6c86e', emoji: 'âš¡' }, // éº¦é»„è‰²
        { name: 'ç»¿æ–¹', color: '#7fb06d', emoji: 'ğŸŒ¿' }, // é¼ å°¾è‰ç»¿
        { name: 'ç´«æ–¹', color: '#b57ecc', emoji: 'ğŸ”®' }, // é¦™èŠ‹ç´«
        { name: 'æ©™æ–¹', color: '#e3aa6d', emoji: 'ğŸŠ' }, // å¥¶æ²¹æ©˜
        { name: 'é’æ–¹', color: '#6db0b8', emoji: 'â„ï¸' }, // ç°æ¹–è“
        { name: 'å¢¨æ–¹', color: '#4a4861', emoji: 'ğŸŒ‘' }, // æ·±å²©ç°
        { name: 'ç²‰æ–¹', color: '#f8a5c2', emoji: 'ğŸŒ¸' }  // æ¨±èŠ±ç²‰
    ];

    const currentTouches = new Map();

    function selectTime(val) {
        selectedTime = val;
        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function launchGame(num) {
        players = colorPalette.slice(0, num).map(p => ({ ...p, score: 0 }));
        time = selectedTime;
        
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('top-bar').style.display = 'flex';
        
        // è®¾ç½®é«˜æ¸…ç”»å¸ƒå°ºå¯¸
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';

        zonesLayer.innerHTML = players.map((p, i) => `
            <div class="zone-cell">
                <div class="zone-hint" style="color: ${p.color}">
                    <h2>P${i+1}</h2>
                    <p>ç‚¹å‡»æ¿€æ´»ï¼š${p.name}</p>
                </div>
            </div>
        `).join('');

        isRunning = true;
        timerDisplay.innerText = time;
        
        const timerInterval = setInterval(() => {
            if (!isRunning) { clearInterval(timerInterval); return; }
            time--;
            timerDisplay.innerText = time;
            updateRanking(); 

            if (time <= 0) {
                isRunning = false;
                showFinalResults();
            }
        }, 1000);
    }

    function getMidPoint(p1, p2) {
        return { x: p1.x + (p2.x - p1.x) / 2, y: p1.y + (p2.y - p1.y) / 2 };
    }

    canvas.addEventListener('pointerdown', e => {
        if (!isRunning) return;
        e.preventDefault(); 
        const zoneWidth = window.innerWidth / players.length;
        const pIdx = Math.floor(e.clientX / zoneWidth);
        
        if (pIdx >= 0 && pIdx < players.length) {
            currentTouches.set(e.pointerId, {
                points: [{x: e.clientX, y: e.clientY}],
                player: players[pIdx],
                lastEmojiTime: 0
            });
            spawnEmoji(e.clientX, e.clientY, players[pIdx].emoji);
        }
    });

    canvas.addEventListener('pointermove', e => {
        if (!isRunning || !currentTouches.has(e.pointerId)) return;
        e.preventDefault();

        const touchData = currentTouches.get(e.pointerId);
        const points = touchData.points;
        points.push({ x: e.clientX, y: e.clientY });

        if (points.length < 3) return;

        const p1 = points[points.length - 3];
        const p2 = points[points.length - 2];
        const p3 = points[points.length - 1];
        const mid1 = getMidPoint(p1, p2);
        const mid2 = getMidPoint(p2, p3);

        ctx.beginPath();
        ctx.strokeStyle = touchData.player.color;
        // ç¨å¾®è°ƒç»†ä¸€ç‚¹ç”»ç¬”ï¼Œé€‚åº”æ›´ç²¾è‡´çš„UI
        ctx.lineWidth = window.innerWidth / (players.length > 4 ? 30 : 18);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.moveTo(mid1.x, mid1.y);
        ctx.quadraticCurveTo(p2.x, p2.y, mid2.x, mid2.y);
        ctx.stroke();

        const now = Date.now();
        if (now - touchData.lastEmojiTime > 100) {
            if(Math.random() > 0.6) {
                spawnEmoji(e.clientX, e.clientY, touchData.player.emoji);
                touchData.lastEmojiTime = now;
            }
        }
    });

    canvas.addEventListener('pointerup', e => currentTouches.delete(e.pointerId));
    canvas.addEventListener('pointercancel', e => currentTouches.delete(e.pointerId));

    function spawnEmoji(x, y, char) {
        const el = document.createElement('div');
        el.className = 'emoji-pop';
        el.innerText = char;
        const offsetX = (Math.random() - 0.5) * 30;
        const offsetY = (Math.random() - 0.5) * 30;
        
        el.style.left = (x + offsetX) + 'px';
        el.style.top = (y + offsetY) + 'px';
        
        emojiLayer.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function updateRanking() {
        const sw = 60, sh = 60;
        const offCanvas = document.createElement('canvas');
        offCanvas.width = sw; offCanvas.height = sh;
        const oCtx = offCanvas.getContext('2d');
        oCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, sw, sh);
        
        const pixels = oCtx.getImageData(0, 0, sw, sh).data;
        const counts = new Array(players.length).fill(0);
        let totalPainted = 0;

        for (let i = 0; i < pixels.length; i += 4) {
            if (pixels[i+3] < 50) continue;
            totalPainted++;
            
            let minD = 999, match = -1;
            players.forEach((p, idx) => {
                const pr = parseInt(p.color.slice(1,3), 16);
                const pg = parseInt(p.color.slice(3,5), 16);
                const pb = parseInt(p.color.slice(5,7), 16);
                const d = Math.abs(pixels[i]-pr) + Math.abs(pixels[i+1]-pg) + Math.abs(pixels[i+2]-pb);
                if (d < minD) { minD = d; match = idx; }
            });
            if (match !== -1) counts[match]++;
        }

        players.forEach((p, i) => p.score = totalPainted === 0 ? 0 : Math.round((counts[i]/totalPainted)*100));
        const sorted = [...players].sort((a,b) => b.score - a.score);

        liveRank.innerHTML = sorted.slice(0, 3).filter(p => p.score > 0).map(p => `
            <div class="rank-item">
                <div style="width:8px; height:8px; border-radius:50%; background:${p.color}"></div>
                ${p.name}: ${p.score}%
            </div>
        `).join('');
    }

    function showFinalResults() {
        document.getElementById('result-screen').style.display = 'flex';
        const list = document.getElementById('final-rank-list');
        const sorted = [...players].sort((a,b) => b.score - a.score);
        list.innerHTML = sorted.map((p, i) => `
            <div class="rank-row" style="color: ${p.color}; border: 1px solid ${p.color}">
                <span>
                    ${i===0 ? 'ğŸ‘‘ ' : ''}NO.${i+1} ${p.name}
                </span>
                <span>${p.score}% ${p.emoji}</span>
            </div>
        `).join('');
    }

    window.oncontextmenu = (e) => e.preventDefault();
</script>
</body>
</html>